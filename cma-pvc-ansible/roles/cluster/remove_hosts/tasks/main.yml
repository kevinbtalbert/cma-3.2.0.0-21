# Copyright (c) 2023, Cloudera, Inc. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

- name: Get hosts details
  cm_api:
    endpoint: /hosts
    method: GET
    timeout: "{{ cluster_restart_timeout | default(3000) }}"
  register: host_details

- name: DEBUG - Get hosts
  debug:
    msg: "{{ host_details }}"
  when: debug | default(false)

- name: Create host to remove
  set_fact:
    hosts_to_remove: "{{ hosts_to_remove | default([]) + host_details.json | community.general.json_query(query) }}"
  vars:
    query: "items[?hostname == '{{ item }}' ].hostname"
  with_items: "{{ groups['pvc_cluster'] }}"

- name: DEBUG - hosts_to_remove
  debug:
    msg: "{{ hosts_to_remove }}"
  when: debug | default(false)

- block:
    - name: DEBUG - remove-hosts.json
      debug:
        msg: "{{ lookup('template', 'remove-hosts.json') }}"
      when: debug | default(false)
    - name: Remove hosts from cluster
      cm_api:
        endpoint: /hosts/removeHostsFromCluster
        method: POST
        body: "{{ lookup('template', 'remove-hosts.json') }}"
        timeout: "{{ cluster_restart_timeout | default(3000) }}"
  when: hosts_to_remove | length > 0